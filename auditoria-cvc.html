<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auditoria CVC - DASA</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="js/api-client.js"></script>
    <script src="js/ui-utils.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/backup-utils.js"></script>
    <script src="js/export-utils.js"></script>
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('js/sw.js')
                .then(() => console.log('Service Worker registered'))
                .catch(err => console.log('Service Worker registration failed:', err));
        }

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                window.dados = await carregarDados('cvc') || [];
                window.atualizarTabela();
                if (window.showToast) {
                    window.showToast('Dados carregados com sucesso');
                }
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                if (window.showToast) {
                    window.showToast('Erro ao carregar dados', 'error');
                }
            }
        });
    </script>
</head>

<body>
    <div class="container fade-in">
        <div class="header">
            <img src="logo-hospital-bahia.png" alt="Hospital da Bahia" class="header-logo">
            <h2>Auditoria de CVC</h2>
        </div>
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <a href="#" onclick="navigateWithLoading('menu.html', 'Voltando ao Menu...')" class="back-button">
                Voltar ao Menu
            </a>
        </div>
        <form id="cvcForm">
            <div class="form-row">
                <div class="form-group">
                    <label>Nome do Paciente:</label>
                    <input type="text" name="nome" required>
                </div>
                <div class="form-group">
                    <label>Data da Auditoria:</label>
                    <input type="date" name="data" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Tem indica√ß√£o de manter o CVC?</label>
                    <select name="indicacaoCVC" required>
                        <option value="">Selecione</option>
                        <option value="1">Sim (Conforme)</option>
                        <option value="0">N√£o (N√£o Conforme)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Tipo de Cateter:</label>
                    <select name="tipoCateter" required>
                        <option value="">Selecione</option>
                        <option value="DL">Duplo L√∫men (DL)</option>
                        <option value="TL">Triplo L√∫men (TL)</option>
                        <option value="Shilley">Shilley</option>
                        <option value="Permcath">Permcath</option>
                        <option value="PICC">PICC</option>
                        <option value="Hickman">Hickman</option>
                        <option value="Port-a-cath">Port-a-cath</option>
                        <option value="Outro">Outro</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Local de Inser√ß√£o:</label>
                    <select name="localInsercao" required>
                        <option value="">Selecione</option>
                        <option value="Femoral">Femoral</option>
                        <option value="Jugular">Jugular</option>
                        <option value="Subcl√°via">Subcl√°via</option>
                        <option value="Outros">Outros</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Tipo de Curativo:</label>
                    <select name="tipoCurativo" required>
                        <option value="">Selecione</option>
                        <option value="Convencional">Convencional (Gaze + Pel√≠cula)</option>
                        <option value="Transparente">Transparente (pel√≠cula)</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>Curativo est√° √≠ntegro, limpo e seco?</label>
                <select name="curativoIntegro" required>
                    <option value="">Selecione</option>
                    <option value="1">Sim</option>
                    <option value="0">N√£o</option>
                </select>
            </div>

            <div class="form-group">
                <label>Curativo com identifica√ß√£o e dentro da validade?</label>
                <select name="curativoIdentificacao" required>
                    <option value="">Selecione</option>
                    <option value="1">Sim</option>
                    <option value="0">N√£o</option>
                </select>
            </div>

            <div class="form-group">
                <label>Equipo e conectores datados e na validade?</label>
                <select name="equipoValidade" required>
                    <option value="">Selecione</option>
                    <option value="1">Sim</option>
                    <option value="0">N√£o</option>
                </select>
            </div>

            <div class="form-group">
                <label>Foi realizado cobertura do CVC antes do banho?</label>
                <select name="coberturaBanho" required>
                    <option value="">Selecione</option>
                    <option value="1">Sim</option>
                    <option value="0">N√£o</option>
                </select>
            </div>

            <div class="form-group">
                <label>Na inser√ß√£o de CVC h√° presen√ßa de sinais flog√≠sticos?</label>
                <select name="sinaisFlogisticos" required>
                    <option value="">Selecione</option>
                    <option value="1">Sim</option>
                    <option value="0">N√£o</option>
                </select>
            </div>

            <div class="form-group">
                <label>Setor:</label>
                <select name="setor" required>
                    <option value="">Selecione o setor</option>
                    <option value="UTI 2B">UTI 2¬∫B</option>
                    <option value="UTI 2C">UTI 2¬∫C</option>
                    <option value="UTI 5C">UTI 5¬∫C</option>
                    <option value="SEMI 6C">SEMI 6C</option>
                    <option value="Unidades Abertas">Unidades Abertas</option>
                </select>
            </div>

            <div class="form-group">
                <label>Observa√ß√µes:</label>
                <textarea name="obs" rows="3"></textarea>
            </div>

            <button type="submit" class="button-primary">Adicionar Registro</button>
        </form>

        <table id="dadosTable">
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Setor</th>
                    <th>Indica√ß√£o CVC</th>
                    <th>Integridade do Curativo</th>
                    <th>Sinais Flog√≠sticos</th>
                    <th>Identifica√ß√£o do Curativo</th>
                    <th>Validade de Equipo</th>
                </tr>
            </thead>
            <tbody></tbody>
            <tfoot>
                <tr>
                    <td colspan="2"><strong>Total</strong></td>
                    <td id="totalIndicacao">0</td>
                    <td id="totalIntegridade">0</td>
                    <td id="totalSinais">0</td>
                    <td id="totalIdentificacao">0</td>
                    <td id="totalValidade">0</td>
                </tr>
            </tfoot>
        </table>

        <div class="form-row" style="margin-top: 20px;">
            <div class="form-group">
                <label>Tipo de Filtro de Data:</label>
                <select id="tipoFiltroData" onchange="toggleFiltroData()">
                    <option value="data">Data Espec√≠fica</option>
                    <option value="periodo">Per√≠odo</option>
                </select>
            </div>
            <div id="filtroDataUnica" class="form-group">
                <label>Data:</label>
                <input type="date" id="filtroData">
            </div>
            <div id="filtroPeriodo" class="form-group" style="display: none;">
                <div style="display: flex; gap: 10px;">
                    <div>
                        <label>Data Inicial:</label>
                        <input type="date" id="filtroDataInicial">
                    </div>
                    <div>
                        <label>Data Final:</label>
                        <input type="date" id="filtroDataFinal">
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label>Filtrar por Setor:</label>
                <select id="filtroSetor">
                    <option value="">Todos os setores</option>
                    <option value="UTI 2B">UTI 2¬∫B</option>
                    <option value="UTI 2C">UTI 2¬∫C</option>
                    <option value="UTI 5C">UTI 5¬∫C</option>
                    <option value="SEMI 6C">SEMI 6C</option>
                    <option value="Unidades Abertas">Unidades Abertas</option>
                </select>
            </div>
        </div>

        <button onclick="exportarCSV()" class="button-primary">
            üìä Exportar para Excel
        </button>

        <div class="backup-controls">
            <button onclick="realizarBackup()" class="button-secondary">
                üíæ Fazer Backup
            </button>
            <input type="file" id="restaurarBackup" accept=".json" style="display: none;">
            <button onclick="document.getElementById('restaurarBackup').click()" class="button-secondary">
                üìÇ Restaurar Backup
            </button>
        </div>

        <script>
            const form = document.getElementById('cvcForm');

            // Dados iniciais
            let dados = [];

            function atualizarTotais() {
                const totais = dados.reduce((acc, linha) => {
                    acc.indicacao += Number(linha[2]);
                    acc.integridade += Number(linha[3]);
                    acc.sinais += Number(linha[4]);
                    acc.identificacao += Number(linha[5]);
                    acc.validade += Number(linha[6]);
                    return acc;
                }, { indicacao: 0, integridade: 0, sinais: 0, identificacao: 0, validade: 0 });

                document.getElementById('totalIndicacao').textContent = totais.indicacao;
                document.getElementById('totalIntegridade').textContent = totais.integridade;
                document.getElementById('totalSinais').textContent = totais.sinais;
                document.getElementById('totalIdentificacao').textContent = totais.identificacao;
                document.getElementById('totalValidade').textContent = totais.validade;
            }

            // Movendo fun√ß√£o para o escopo global
            window.dados = [];

            window.atualizarTabela = function () {
                const tabela = document.getElementById('dadosTable').getElementsByTagName('tbody')[0];
                tabela.innerHTML = '';

                if (window.dados && Array.isArray(window.dados)) {
                    window.dados.forEach(linha => {
                        const row = tabela.insertRow();
                        linha.forEach(valor => {
                            const td = row.insertCell();
                            td.textContent = valor;
                        });
                    });

                    // Atualizar totais
                    const colunas = ['Indicacao', 'Integridade', 'Sinais', 'Identificacao', 'Validade'];
                    const totais = calcularTotais(window.dados, colunas);
                    atualizarTotaisNaTabela(totais);
                }
            }

            // Carregar dados ao iniciar
            async function inicializarDados() {
                dados = await carregarDados('cvc');
                atualizarTabela();
            }

            form.onsubmit = async function (e) {
                e.preventDefault();
                const formData = new FormData(form);

                // Valida√ß√£o do formul√°rio
                const { isValid, errors } = validarFormulario(formData, 'cvc');
                if (!isValid) {
                    mostrarErros(errors);
                    return;
                }

                // Confirma√ß√£o antes de salvar
                if (!await confirmarEnvio()) {
                    return;
                }

                showLoadingWithMessage('Salvando registro...');
                try {
                    const linha = [
                        formData.get('data'),
                        formData.get('setor'),
                        Number(formData.get('indicacaoCVC')),
                        Number(formData.get('curativoIntegro')),
                        Number(formData.get('sinaisFlogisticos')),
                        Number(formData.get('curativoIdentificacao')),
                        Number(formData.get('equipoValidade'))
                    ];
                    await salvarRegistro('cvc', linha);
                    dados.push(linha);
                    atualizarTabela();
                    form.reset();
                    showToast('Registro salvo com sucesso!');
                } catch (error) {
                    showToast('Erro ao salvar registro', 'error');
                } finally {
                    hideLoading();
                }
            };

            function toggleFiltroData() {
                const tipo = document.getElementById('tipoFiltroData').value;
                document.getElementById('filtroDataUnica').style.display =
                    tipo === 'data' ? 'block' : 'none';
                document.getElementById('filtroPeriodo').style.display =
                    tipo === 'periodo' ? 'block' : 'none';
            }

            // Inicializa tabela vazia
            atualizarTabela();
            inicializarDados();
        </script>
    </div>

</body>

</html>