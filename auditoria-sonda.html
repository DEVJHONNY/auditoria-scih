<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auditoria Sonda - DASA</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="js/api-client.js"></script>
    <script src="js/ui-utils.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/backup-utils.js"></script>
    <script src="js/export-utils.js"></script>
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('js/sw.js')
                .then(() => console.log('Service Worker registered'))
                .catch(err => console.log('Service Worker registration failed:', err));
        }

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                window.dados = await carregarDados('sonda') || [];
                window.atualizarTabela();
                if (window.showToast) {
                    window.showToast('Dados carregados com sucesso');
                }
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                if (window.showToast) {
                    window.showToast('Erro ao carregar dados', 'error');
                }
            }
        });
    </script>
</head>

<body>
    <div class="container fade-in">
        <div class="header">
            <img src="logo-hospital-bahia.png" alt="Hospital da Bahia" class="header-logo">
            <h2>Auditoria de Sonda Vesical</h2>
        </div>
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <a href="#" onclick="navigateWithLoading('menu.html', 'Voltando ao Menu...')" class="back-button">
                Voltar ao Menu
            </a>
        </div>
        <form id="sondaForm">
            <div class="form-row">
                <div class="form-group">
                    <label>Nome do Paciente:</label>
                    <input type="text" name="nome" required>
                </div>
                <div class="form-group">
                    <label>Data da Auditoria:</label>
                    <input type="date" name="data" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Tem Indica√ß√£o de Cateter SVD:</label>
                    <select name="indicacaoSVD" required>
                        <option value="">Selecione</option>
                        <option value="1">Sim (Conforme)</option>
                        <option value="0">N√£o (N√£o Conforme)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Tipo de SVD:</label>
                    <select name="tipoSVD" required>
                        <option value="">Selecione</option>
                        <option value="C">Comum</option>
                        <option value="T">Tr√™s vias</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>Sistema fechado √≠ntegro e com data:</label>
                <select name="sistemaFechado" required>
                    <option value="">Selecione</option>
                    <option value="1">Sim</option>
                    <option value="0">N√£o</option>
                </select>
            </div>

            <div class="form-group">
                <label>Bolsa coletora abaixo do n√≠vel da bexiga:</label>
                <select name="bolsaColetora" required>
                    <option value="">Selecione</option>
                    <option value="S">Sim</option>
                    <option value="N">N√£o</option>
                </select>
            </div>

            <div class="form-group">
                <label>Fixa√ß√£o adequada do dispositivo:</label>
                <select name="fixacao" required>
                    <option value="">Selecione</option>
                    <option value="S">Sim</option>
                    <option value="N">N√£o</option>
                </select>
            </div>

            <div class="form-group">
                <label>Setor:</label>
                <select name="setor" required>
                    <option value="">Selecione o setor</option>
                    <option value="UTI 2B">UTI 2¬∫B</option>
                    <option value="UTI 2C">UTI 2¬∫C</option>
                    <option value="UTI 5C">UTI 5¬∫C</option>
                    <option value="SEMI 6C">SEMI 6C</option>
                    <option value="Unidades Abertas">Unidades Abertas</option>
                </select>
            </div>

            <div class="form-group">
                <label>Observa√ß√µes:</label>
                <textarea name="obs" rows="3"></textarea>
            </div>

            <button type="submit" class="button-primary">Adicionar Registro</button>
        </form>

        <table id="dadosTable">
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Setor</th>
                    <th>SVD Indica√ß√£o Adequada</th>
                    <th>Fixa√ß√£o SVD</th>
                    <th>Higiene √çntima</th>
                    <th>Fluxo Desobstru√≠do</th>
                    <th>Coletor Abaixo Bexiga</th>
                    <th>Coletor sem Tocar Ch√£o</th>
                    <th>Coletor at√© 2/3</th>
                </tr>
            </thead>
            <tbody></tbody>
            <tfoot>
                <tr>
                    <td colspan="2"><strong>Total</strong></td>
                    <td id="totalIndicacao">0</td>
                    <td id="totalFixacao">0</td>
                    <td id="totalHigiene">0</td>
                    <td id="totalFluxo">0</td>
                    <td id="totalColetor">0</td>
                    <td id="totalChao">0</td>
                    <td id="totalVolume">0</td>
                </tr>
            </tfoot>
        </table>

        <div class="form-row" style="margin-top: 20px;">
            <div class="form-group">
                <label>Tipo de Filtro de Data:</label>
                <select id="tipoFiltroData" onchange="toggleFiltroData()">
                    <option value="data">Data Espec√≠fica</option>
                    <option value="periodo">Per√≠odo</option>
                </select>
            </div>
            <div id="filtroDataUnica" class="form-group">
                <label>Data:</label>
                <input type="date" id="filtroData">
            </div>
            <div id="filtroPeriodo" class="form-group" style="display: none;">
                <div style="display: flex; gap: 10px;">
                    <div>
                        <label>Data Inicial:</label>
                        <input type="date" id="filtroDataInicial">
                    </div>
                    <div>
                        <label>Data Final:</label>
                        <input type="date" id="filtroDataFinal">
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label>Filtrar por Setor:</label>
                <select id="filtroSetor">
                    <option value="">Todos os setores</option>
                    <option value="UTI 2B">UTI 2¬∫B</option>
                    <option value="UTI 2C">UTI 2¬∫C</option>
                    <option value="UTI 5C">UTI 5¬∫C</option>
                    <option value="SEMI 6C">SEMI 6C</option>
                    <option value="Unidades Abertas">Unidades Abertas</option>
                </select>
            </div>
        </div>

        <button onclick="exportarCSV()" class="button-primary">
            üìä Exportar para Excel
        </button>

        <div class="backup-controls">
            <button onclick="realizarBackup()" class="button-secondary">
                üíæ Fazer Backup
            </button>
            <input type="file" id="restaurarBackup" accept=".json" style="display: none;">
            <button onclick="document.getElementById('restaurarBackup').click()" class="button-secondary">
                üìÇ Restaurar Backup
            </button>
        </div>

        <script>
            const form = document.getElementById('sondaForm');

            // Dados iniciais
            window.dados = [];

            window.atualizarTabela = function () {
                const tabela = document.getElementById('dadosTable').getElementsByTagName('tbody')[0];
                tabela.innerHTML = '';

                if (window.dados && Array.isArray(window.dados)) {
                    window.dados.forEach(linha => {
                        const row = tabela.insertRow();
                        linha.forEach(valor => {
                            const td = row.insertCell();
                            td.textContent = valor;
                        });
                    });

                    // Atualizar totais
                    const colunas = ['Indicacao', 'Fixacao', 'Higiene', 'Fluxo', 'Coletor', 'Chao', 'Volume'];
                    const totais = calcularTotais(window.dados, colunas);
                    atualizarTotaisNaTabela(totais);
                }
            }

            function toggleFiltroData() {
                const tipo = document.getElementById('tipoFiltroData').value;
                document.getElementById('filtroDataUnica').style.display =
                    tipo === 'data' ? 'block' : 'none';
                document.getElementById('filtroPeriodo').style.display =
                    tipo === 'periodo' ? 'block' : 'none';
            }

            // Atualiza a tabela e os totais ao carregar a p√°gina
            atualizarTabela();

            // Atualiza os totais ap√≥s adicionar novo registro
            form.onsubmit = async function (e) {
                e.preventDefault();
                const formData = new FormData(form);

                // Valida√ß√£o do formul√°rio
                const { isValid, errors } = validarFormulario(formData, 'sonda');
                if (!isValid) {
                    mostrarErros(errors);
                    return;
                }

                // Confirma√ß√£o antes de salvar
                if (!await confirmarEnvio()) {
                    return;
                }

                showLoadingWithMessage('Salvando registro...');
                try {
                    const linha = [
                        formData.get('data'),
                        formData.get('setor'),
                        Number(formData.get('indicacaoSVD')),
                        Number(formData.get('fixacao')),
                        Number(formData.get('higieneIntima')),
                        Number(formData.get('fluxoDesobstruido')),
                        Number(formData.get('coletorAbaixo')),
                        Number(formData.get('coletorChao')),
                        Number(formData.get('coletorVolume'))
                    ];
                    await salvarRegistro('sonda', linha);
                    dados.push(linha);
                    atualizarTabela();
                    form.reset();
                    showToast('Registro salvo com sucesso!');
                } catch (error) {
                    showToast('Erro ao salvar registro', 'error');
                } finally {
                    hideLoading();
                }
            };

            // Inicializar gr√°ficos ap√≥s carregar dados
            function atualizarGraficos() {
                criarGraficoSetor(dados, 'sonda');
                criarGraficoTendencia(dados);
            }

            // Adicionar handler para backup
            document.getElementById('restaurarBackup').onchange = async function (e) {
                showLoadingWithMessage('Restaurando backup...');
                const success = await restaurarBackup(e.target.files[0]);
                if (success) {
                    showToast('Backup restaurado com sucesso!');
                    await inicializarDados();
                    atualizarGraficos();
                } else {
                    showToast('Erro ao restaurar backup', 'error');
                }
                hideLoading();
            };

            window.realizarBackup = realizarBackup;
        </script>
    </div>
</body>

</html>