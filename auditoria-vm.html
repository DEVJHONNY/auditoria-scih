<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auditoria VM - DASA</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="js/api-client.js"></script>
    <script src="js/ui-utils.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/backup-utils.js"></script>
    <script src="js/export-utils.js"></script>
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('js/sw.js')
                .then(() => console.log('Service Worker registered'))
                .catch(err => console.log('Service Worker registration failed:', err));
        }

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                window.dados = await carregarDados('vm') || [];
                window.atualizarTabela();
                if (window.showToast) {
                    window.showToast('Dados carregados com sucesso');
                }
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                if (window.showToast) {
                    window.showToast('Erro ao carregar dados', 'error');
                }
            }
        });

        const form = document.getElementById('vmForm');

        // Dados iniciais
        window.dados = [];

        window.atualizarTabela = function () {
            const tabela = document.getElementById('dadosTable').getElementsByTagName('tbody')[0];
            tabela.innerHTML = '';

            if (window.dados && Array.isArray(window.dados)) {
                window.dados.forEach(linha => {
                    const row = tabela.insertRow();
                    linha.forEach(valor => {
                        const td = row.insertCell();
                        td.textContent = valor;
                    });
                });

                // Atualizar totais - incluindo pressão do cuff
                const totais = window.dados.reduce((acc, linha) => {
                    acc.descontinuidade += Number(linha[2] || 0);
                    acc.pressaoCuffMedida += Number(linha[3] || 0);
                    acc.pressaoCuffAdequada += Number(linha[4] || 0);
                    acc.higiene += Number(linha[5] || 0);
                    acc.cabeceira += Number(linha[6] || 0);
                    acc.condensado += Number(linha[7] || 0);
                    acc.filtro += Number(linha[8] || 0);
                    acc.identificacao += Number(linha[9] || 0);
                    acc.sne += Number(linha[10] || 0);
                    return acc;
                }, {
                    descontinuidade: 0, pressaoCuffMedida: 0, pressaoCuffAdequada: 0,
                    higiene: 0, cabeceira: 0, condensado: 0, filtro: 0, identificacao: 0, sne: 0
                });

                // Atualizar células de total
                document.getElementById('totalDescontinuidade').textContent = totais.descontinuidade;
                document.getElementById('totalPressaoCuffMedida').textContent = totais.pressaoCuffMedida;
                document.getElementById('totalPressaoCuffAdequada').textContent = totais.pressaoCuffAdequada;
                document.getElementById('totalHigiene').textContent = totais.higiene;
                document.getElementById('totalCabeceira').textContent = totais.cabeceira;
                document.getElementById('totalCondensado').textContent = totais.condensado;
                document.getElementById('totalFiltro').textContent = totais.filtro;
                document.getElementById('totalIdentificacao').textContent = totais.identificacao;
                document.getElementById('totalSNE').textContent = totais.sne;
            }
        };
    </script>
</head>

<body>
    <div class="container fade-in">
        <div class="header">
            <img src="logo-hospital-bahia.png" alt="Hospital da Bahia" class="header-logo">
            <h2>Auditoria de Ventilação Mecânica</h2>
        </div>
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <a href="#" onclick="navigateWithLoading('menu.html', 'Voltando ao Menu...')" class="back-button">
                Voltar ao Menu
            </a>
        </div>
        <form id="vmForm">
            <div class="form-row">
                <div class="form-group">
                    <label>Nome do Paciente:</label>
                    <input type="text" name="nome" required>
                </div>
                <div class="form-group">
                    <label>Data da Auditoria:</label>
                    <input type="date" name="data" required>
                </div>
                <div class="form-group">
                    <label>Setor:</label>
                    <select name="setor" required>
                        <option value="">Selecione o setor</option>
                        <option value="UTI 2B">UTI 2ºB</option>
                        <option value="UTI 2C">UTI 2ºC</option>
                        <option value="UTI 5C">UTI 5ºC</option>
                        <option value="SEMI 6C">SEMI 6C</option>
                        <option value="Unidades Abertas">Unidades Abertas</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Possibilidade de descontinuidade VM?</label>
                    <select name="descontinuidadeVM" required>
                        <option value="">Selecione</option>
                        <option value="1">Sim</option>
                        <option value="0">Não</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Pressão do Cuff mensurada (1x/Dia):</label>
                    <select name="pressaoCuffMedida" required>
                        <option value="">Selecione</option>
                        <option value="1">Sim</option>
                        <option value="0">Não</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Pressão do Cuff adequada (25-30 cmH2O):</label>
                    <select name="pressaoCuffAdequada" required>
                        <option value="">Selecione</option>
                        <option value="1">Sim (Conforme)</option>
                        <option value="0">Não (Não Conforme)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Higiene Oral realizada (3x/Dia):</label>
                    <select name="higieneOral" required>
                        <option value="">Selecione</option>
                        <option value="1">Sim</option>
                        <option value="0">Não</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Cabeceira elevada 30-45º:</label>
                    <select name="cabeceira" required>
                        <option value="">Selecione</option>
                        <option value="1">Sim</option>
                        <option value="0">Não</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Ausência de excesso de água/condensado na traquéia:</label>
                    <select name="condensado" required>
                        <option value="">Selecione</option>
                        <option value="1">Sim</option>
                        <option value="0">Não</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>A posição do filtro está adequada?</label>
                    <select name="filtro" required>
                        <option value="">Selecione</option>
                        <option value="1">Sim</option>
                        <option value="0">Não</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>TOT/TQT identificada?</label>
                    <select name="identificacao" required>
                        <option value="">Selecione</option>
                        <option value="1">Sim</option>
                        <option value="0">Não</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>SNE bem fixada/posicionada:</label>
                <select name="sne" required>
                    <option value="">Selecione</option>
                    <option value="1">Sim</option>
                    <option value="0">Não</option>
                </select>
            </div>

            <div class="form-group">
                <label>Observações:</label>
                <textarea name="obs" rows="3"></textarea>
            </div>

            <button type="submit" class="button-primary">Adicionar Registro</button>
        </form>

        <table id="dadosTable">
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Setor</th>
                    <th>Possibilidade de descontinuidade VM?</th>
                    <th>Pressão do Cuff mensurada (1x/Dia)</th>
                    <th>Pressão do Cuff adequada (25-30 cmH2O)</th>
                    <th>Higiene Oral realizada (3x/Dia)</th>
                    <th>Cabeceira elevada 30-45º</th>
                    <th>Ausência de exesso água/condensado na traquéia</th>
                    <th>A posição do filtro está adequada?</th>
                    <th>TOT/TQT identificada?</th>
                    <th>SNE bem fixada/posicionada</th>
                </tr>
            </thead>
            <tbody></tbody>
            <tfoot>
                <tr>
                    <td colspan="2"><strong>Total</strong></td>
                    <td id="totalDescontinuidade">0</td>
                    <td id="totalPressaoCuffMedida">0</td>
                    <td id="totalPressaoCuffAdequada">0</td>
                    <td id="totalHigiene">0</td>
                    <td id="totalCabeceira">0</td>
                    <td id="totalCondensado">0</td>
                    <td id="totalFiltro">0</td>
                    <td id="totalIdentificacao">0</td>
                    <td id="totalSNE">0</td>
                </tr>
            </tfoot>
        </table>

        <div class="form-row" style="margin-top: 20px;">
            <div class="form-group">
                <label>Tipo de Filtro de Data:</label>
                <select id="tipoFiltroData" onchange="toggleFiltroData()">
                    <option value="data">Data Específica</option>
                    <option value="periodo">Período</option>
                </select>
            </div>
            <div id="filtroDataUnica" class="form-group">
                <label>Data:</label>
                <input type="date" id="filtroData">
            </div>
            <div id="filtroPeriodo" class="form-group" style="display: none;">
                <div style="display: flex; gap: 10px;">
                    <div>
                        <label>Data Inicial:</label>
                        <input type="date" id="filtroDataInicial">
                    </div>
                    <div>
                        <label>Data Final:</label>
                        <input type="date" id="filtroDataFinal">
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label>Filtrar por Setor:</label>
                <select id="filtroSetor">
                    <option value="">Todos os setores</option>
                    <option value="UTI 2B">UTI 2ºB</option>
                    <option value="UTI 2C">UTI 2ºC</option>
                    <option value="UTI 5C">UTI 5ºC</option>
                    <option value="SEMI 6C">SEMI 6C</option>
                    <option value="Unidades Abertas">Unidades Abertas</option>
                </select>
            </div>
        </div>

        <button onclick="exportarCSV()" class="button-primary">
            📊 Exportar para Excel
        </button>

        <div class="backup-controls">
            <button onclick="realizarBackup()" class="button-secondary">
                💾 Fazer Backup
            </button>
            <input type="file" id="restaurarBackup" accept=".json" style="display: none;">
            <button onclick="document.getElementById('restaurarBackup').click()" class="button-secondary">
                📂 Restaurar Backup
            </button>
        </div>
    </div>

</body>

</html>